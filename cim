#!/usr/bin/python
##
# This file is part of CimCity.
#
# CimCity is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# CimCity is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with CimCity.  If not, see <http://www.gnu.org/licenses/>.
##

from __future__ import absolute_import, division, print_function, unicode_literals
from threading import Timer
import sys
import time

from items.house import *
from items.person import Person
import settings

version = "0.0.1"

def alive(people):
    return len([p for p in people if not p.dead])


def dead(people):
    return len([p for p in people if p.dead])


def display(people, ticks):
    msg = "Alive: %s | Dead: %s | Homeless: %s | ticks %s\r"
    msg = msg % (alive(people), dead(people), len(homeless), ticks)
    sys.stdout.write(msg)
    sys.stdout.flush()


class GayOnExit(object):
    """Gay context manager"""

    def __init__(self, people):
        """Takes list of people"""
        self.people = people

    def __enter__(self):
        pass

    def __exit__(self, exc_type, exc_value, traceback):
        if exc_type is KeyboardInterrupt:
            print("\r", end="")
            display(self.people, ticks)
            print()

            gay_couples = 0
            for i in self.people:
                if i.partner is not None and i.sex == i.partner.sex:
                    gay_couples = gay_couples + 1

            # assume monogamy
            gay_couples = gay_couples / 2
            popn = len(self.people)

            ratio = 100 * gay_couples / popn
            print("Percentage of same gender couples: %f" % ratio)
            return True
        return exc_type is None


if __name__ == "__main__":
    if "-v" in sys.argv[1:] or "--version" in sys.argv[1:]:
        print("The version is: %s" % version)
        sys.exit()

    if len(sys.argv) <= 1:
        print("You need to say how many people to start off with")
        print("Usage:  %s <people>" % sys.argv[0])
        sys.exit()

    # inital people gen
    people = [Person() for i in range(int(sys.argv[1]))]
    houses = [House() for i in range(4)]

    left_over = people[:]
    for house in houses:
        if not house.add_occupants(left_over):
            break

    homeless.add_occupants(left_over)

    c = 0
    ticks = 0
    speed = 60 / settings.speed

    with GayOnExit(people):
        while True:
            timer = Timer(speed, lambda *x:x)
            timer.start()

            display(people, ticks)

            # main game loop
            while True:
                try:
                    person = people[c]
                except IndexError:
                    break

                c += 1

                try:
                    np = person.on_tick(people[c])
                except IndexError:
                    np = person.on_tick()

                if np:
                    people.append(np)
                    np = [np]
                    for house in houses:
                        if not house.add_occupants(np):
                            break
                    homeless.add_occupants(np)

            ticks += 1
            c = 0
            timer.join()
